<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è·AI åŒ»ç”Ÿé¡¹ç›®æ¼”ç¤ºå¤§çº²</title>
    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --code-bg: #1e293b;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-color);
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        header {
            text-align: center;
            margin-bottom: 60px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        h2 {
            color: var(--secondary-color);
            border-left: 5px solid var(--primary-color);
            padding-left: 15px;
            margin-top: 50px;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        h3 {
            color: var(--text-primary);
            margin-top: 25px;
            font-size: 1.4rem;
        }
        h4 {
            color: var(--secondary-color);
            margin-top: 20px;
            font-size: 1.1rem;
        }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        li::before {
            content: "â€¢";
            color: var(--primary-color);
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        .tech-stack {
            background-color: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            font-family: "Courier New", Courier, monospace;
            font-size: 0.9rem;
            color: #0f172a;
            border: 1px solid #e2e8f0;
        }
        .footer {
            text-align: center;
            margin-top: 60px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        /* Mermaid diagram container */
        .mermaid-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        /* Code blocks */
        pre {
            border-radius: 8px;
            padding: 0;
            margin: 15px 0;
            overflow-x: auto;
        }
        pre code {
            display: block;
            padding: 16px;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        code {
            font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
            font-size: 0.9em;
        }
        :not(pre) > code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            color: #1e40af;
        }
        /* Intent badges */
        .intent-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin: 4px;
        }
        .intent-symptom { background: #dbeafe; color: #1e40af; }
        .intent-medicine { background: #fef3c7; color: #92400e; }
        .intent-hospital { background: #dcfce7; color: #166534; }
        .intent-health { background: #f3e8ff; color: #7c3aed; }
        .intent-general { background: #e2e8f0; color: #475569; }
        .intent-emergency { background: #fee2e2; color: #dc2626; }
        /* Event type indicators */
        .event-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .event-status { background: #dbeafe; color: #1e40af; }
        .event-content { background: #dcfce7; color: #166534; }
        .event-tool { background: #fef3c7; color: #92400e; }
        .event-error { background: #fee2e2; color: #dc2626; }
        .event-metadata { background: #f3e8ff; color: #7c3aed; }
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--secondary-color);
        }
        tr:hover {
            background: #f8fafc;
        }
        /* Section divider */
        .section-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #e2e8f0, transparent);
            margin: 40px 0;
        }
        /* Tabs for code examples */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 0;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab:hover {
            color: var(--primary-color);
        }
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ¥ å°è·AI åŒ»ç”Ÿé¡¹ç›®æ¼”ç¤º</h1>
        <p>åŸºäº AI Agent ä¸å®æ—¶é€šä¿¡çš„å…¨æµç¨‹åŒ»ç–—å¥åº·å¹³å°</p>
    </header>

    <!-- 01. é¡¹ç›®æ¦‚è§ˆ -->
    <section>
        <h2>01. é¡¹ç›®æ¦‚è§ˆ (Project Overview)</h2>
        <div class="card">
            <p><strong>é¡¹ç›®ç®€ä»‹ï¼š</strong> å°è·AI åŒ»ç”Ÿæ˜¯ä¸€ä¸ªé›†æˆäº†äººå·¥æ™ºèƒ½ä¸ä¼ ç»ŸåŒ»ç–—æœåŠ¡çš„ç»¼åˆå¹³å°ã€‚</p>
            <p><strong>æ ¸å¿ƒä¸‰å¤§æ¨¡å—ï¼š</strong></p>
            <ol style="list-style-type: decimal; padding-left: 20px;">
                <li><strong>AI åŒ»ç”Ÿå¯¹è¯ï¼š</strong> 7x24å°æ—¶æ™ºèƒ½åˆè¯Šä¸å’¨è¯¢ã€‚</li>
                <li><strong>ä¸“å®¶é—®è¯Šï¼š</strong> å¤æ‚ç—…ä¾‹çš„çœŸäººåŒ»ç”Ÿåœ¨çº¿å’¨è¯¢ã€‚</li>
                <li><strong>é¢„çº¦æŒ‚å·ï¼š</strong> çº¿ä¸Šé¢„çº¦çº¿ä¸‹é—¨è¯ŠæœåŠ¡ã€‚</li>
            </ol>
        </div>
    </section>

    <!-- 02. AI åŒ»ç”Ÿå¯¹è¯æ¼”ç¤º -->
    <section>
        <h2>02. æ¼”ç¤ºæ¨¡å—ä¸€ï¼šAI åŒ»ç”Ÿå¯¹è¯ (AI Consultation)</h2>
        <div class="card">
            <h3>æ¼”ç¤ºåœºæ™¯ (Demo Cases)</h3>
            <ul>
                <li>
                    <strong>Case 1: å¸¸è§ç—…å’¨è¯¢ / è¯å“å»ºè®®</strong>
                    <br>
                    <em>ç”¨æˆ·æé—®ï¼š</em> "æ„Ÿå†’åƒè¿™ä¸ªè¯å¯ä»¥å—"
                    <br>
                    <em>æ¼”ç¤ºé‡ç‚¹ï¼š</em> Agent è¯†åˆ«"ç”¨è¯å’¨è¯¢"æ„å›¾ï¼Œåˆ†æè¯ç‰©é€‚ç”¨æ€§ï¼Œç»™å‡ºå®‰å…¨å»ºè®®ã€‚
                </li>
                <li>
                    <strong>Case 2: å°±åŒ»å¯¼è¯Š / åŒ»ç”Ÿæ¨è</strong>
                    <br>
                    <em>ç”¨æˆ·æé—®ï¼š</em> "åŒ—äº¬åå’ŒåŒ»é™¢çœ‹å¿ƒè„ç—…æ¨èå“ªä¸ªåŒ»ç”Ÿ"
                    <br>
                    <em>æ¼”ç¤ºé‡ç‚¹ï¼š</em> Agent è°ƒç”¨è”ç½‘æœç´¢æˆ–å†…éƒ¨æ•°æ®åº“å·¥å…·ï¼Œæ£€ç´¢ç‰¹å®šåŒ»é™¢ç§‘å®¤ä¿¡æ¯ï¼Œæ¨èåˆé€‚ä¸“å®¶ã€‚
                </li>
            </ul>
        </div>
    </section>

    <!-- 03. é¢„çº¦æŒ‚å· -->
    <section>
        <h2>03. æ¼”ç¤ºæ¨¡å—äºŒï¼šé¢„çº¦æŒ‚å· (Appointment System)</h2>
        <div class="card">
            <h3>æ¼”ç¤ºæµç¨‹</h3>
            <p>ç”¨æˆ·ä»æ¨èåŒ»ç”Ÿæˆ–ç›´æ¥æµè§ˆæ’ç­è¿›å…¥é¢„çº¦æµç¨‹ï¼š</p>
            <ol style="list-style-type: decimal; padding-left: 20px;">
                <li><strong>æŸ¥çœ‹æ’ç­ï¼š</strong> å±•ç¤ºåŒ»ç”Ÿå¯é¢„çº¦çš„æ—¶é—´æ®µã€‚</li>
                <li><strong>æäº¤é¢„çº¦ï¼š</strong> ç”¨æˆ·é€‰æ‹©æ—¶é—´ï¼Œç¡®è®¤ä¿¡æ¯ã€‚</li>
                <li><strong>çŠ¶æ€æµè½¬ï¼š</strong> æ¼”ç¤º"å¾…ç¡®è®¤" â†’ "é¢„çº¦æˆåŠŸ"çš„çŠ¶æ€å˜åŒ–ã€‚</li>
            </ol>
        </div>
    </section>

    <!-- 04. ä¸“å®¶é—®è¯Š -->
    <section>
        <h2>04. æ¼”ç¤ºæ¨¡å—ä¸‰ï¼šä¸“å®¶é—®è¯Š (Expert Consultation)</h2>
        <div class="card">
            <h3>æ¼”ç¤ºæµç¨‹</h3>
            <p>å¯¹äº AI æ— æ³•å®Œå…¨è§£å†³çš„å¤æ‚é—®é¢˜ï¼Œæ— ç¼è½¬æ¥ä¸“å®¶ï¼š</p>
            <ul>
                <li><strong>å³æ—¶é€šè®¯ï¼š</strong> æ‚£è€…ä¸åŒ»ç”Ÿè¿›è¡Œå®æ—¶å›¾æ–‡å¯¹è¯ã€‚</li>
                <li><strong>ä¿¡æ¯åŒæ­¥ï¼š</strong> åŒ»ç”Ÿç«¯æŸ¥çœ‹æ‚£è€…ä¹‹å‰çš„ AI é—®è¯Šæ‘˜è¦ï¼ˆä¸Šä¸‹æ–‡ï¼‰ã€‚</li>
            </ul>
        </div>
    </section>

    <div class="section-divider"></div>

    <!-- 05. æ ¸å¿ƒæŠ€æœ¯å®ç° - AI Agent è¯¦è§£ -->
    <section>
        <h2>05. AI Agent æ ¸å¿ƒæ¶æ„ (Agent Architecture)</h2>

        <!-- 5.1 æ•´ä½“å·¥ä½œæµç¨‹ -->
        <div class="card">
            <h3>5.1 LangGraph çŠ¶æ€å›¾å·¥ä½œæµ</h3>
            <p>AI Agent åŸºäº <strong>LangGraph</strong> æ„å»ºï¼Œä½¿ç”¨ <code>StateGraph</code> å®šä¹‰å¯æ§çš„å¯¹è¯å·¥ä½œæµã€‚</p>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TB
    subgraph "Agent StateGraph"
        START((å¼€å§‹)) --> CI[classifyIntent<br/>æ„å›¾åˆ†ç±»]

        CI --> |routeDecision| ROUTE{è·¯ç”±å†³ç­–}

        ROUTE -->|quick| QR[quickResponse<br/>å¿«é€Ÿå“åº”é€šé“]
        ROUTE -->|react| RL[reactLoop<br/>ReAct å¾ªç¯]

        QR --> END1((ç»“æŸ))

        RL --> CHECK{isFinished?}
        CHECK -->|false| RL
        CHECK -->|true| FR[finalResponse<br/>æœ€ç»ˆå“åº”]

        FR --> END2((ç»“æŸ))
    end

    style CI fill:#dbeafe,stroke:#2563eb
    style QR fill:#dcfce7,stroke:#10b981
    style RL fill:#fef3c7,stroke:#f59e0b
    style FR fill:#f3e8ff,stroke:#7c3aed
                </pre>
            </div>

            <h4>èŠ‚ç‚¹è¯´æ˜</h4>
            <table>
                <thead>
                    <tr>
                        <th>èŠ‚ç‚¹</th>
                        <th>èŒè´£</th>
                        <th>å…³é”®é€»è¾‘</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>classifyIntent</code></td>
                        <td>æ„å›¾è¯†åˆ« + è·¯ç”±å†³ç­–</td>
                        <td>è°ƒç”¨ LLM åˆ†æç”¨æˆ·æ¶ˆæ¯ï¼Œæå–æ„å›¾ã€å®ä½“ã€é£é™©æŒ‡æ ‡</td>
                    </tr>
                    <tr>
                        <td><code>quickResponse</code></td>
                        <td>å¿«é€Ÿå“åº”é€šé“</td>
                        <td>å•æ„å›¾ç®€å•åœºæ™¯ï¼Œä¸€æ¬¡æŸ¥è¯¢ + ä¸€æ¬¡ LLM ç”Ÿæˆ</td>
                    </tr>
                    <tr>
                        <td><code>reactLoop</code></td>
                        <td>ReAct æ¨ç†å¾ªç¯</td>
                        <td>å¤šè½® Think â†’ Act â†’ Observeï¼Œæœ€å¤š 5 æ¬¡è¿­ä»£</td>
                    </tr>
                    <tr>
                        <td><code>finalResponse</code></td>
                        <td>æ”¶å°¾å¤„ç†</td>
                        <td>å‘é€ä¼šè¯ç»“æŸäº‹ä»¶ï¼Œå¤„ç†é™çº§å“åº”</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 5.2 æ„å›¾åˆ†ç±»ç³»ç»Ÿ -->
        <div class="card">
            <h3>5.2 æ„å›¾åˆ†ç±»ç³»ç»Ÿ (Intent Classification)</h3>
            <p>ç³»ç»Ÿæ”¯æŒ <strong>6 ç§æ ¸å¿ƒæ„å›¾</strong>ï¼Œæ¯ç§æ„å›¾å¯¹åº”ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼š</p>

            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 20px 0;">
                <span class="intent-badge intent-symptom">ğŸ©º symptom_consult</span>
                <span class="intent-badge intent-medicine">ğŸ’Š medicine_info</span>
                <span class="intent-badge intent-hospital">ğŸ¥ hospital_recommend</span>
                <span class="intent-badge intent-health">â¤ï¸ health_advice</span>
                <span class="intent-badge intent-general">ğŸ’¬ general_qa</span>
                <span class="intent-badge intent-emergency">ğŸš¨ emergency</span>
            </div>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart LR
    subgraph "æ„å›¾åˆ†ç±»å™¨"
        INPUT[ç”¨æˆ·æ¶ˆæ¯] --> LLM[DeepSeek LLM]
        LLM --> PARSE[JSON è§£æ]
    end

    PARSE --> INTENTS[æ„å›¾åˆ—è¡¨]
    PARSE --> ENTITIES[å®ä½“æå–]
    PARSE --> RISK[é£é™©æŒ‡æ ‡]

    INTENTS --> ROUTE{è·¯ç”±å†³ç­–}
    RISK --> ROUTE

    ROUTE -->|"å•æ„å›¾ + ä½é£é™©"| QUICK[Quick é€šé“]
    ROUTE -->|"å¤šæ„å›¾ / é«˜é£é™© / ç´§æ€¥"| REACT[ReAct å¾ªç¯]

    style LLM fill:#dbeafe,stroke:#2563eb
    style QUICK fill:#dcfce7,stroke:#10b981
    style REACT fill:#fef3c7,stroke:#f59e0b
                </pre>
            </div>

            <h4>æ„å›¾è¯¦ç»†è¯´æ˜</h4>
            <table>
                <thead>
                    <tr>
                        <th>æ„å›¾ç±»å‹</th>
                        <th>ä¸­æ–‡åç§°</th>
                        <th>ç¤ºä¾‹</th>
                        <th>é»˜è®¤é€šé“</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>symptom_consult</code></td>
                        <td>ç—‡çŠ¶å’¨è¯¢</td>
                        <td>"å¤´ç–¼ã€å‘çƒ§æ€ä¹ˆåŠ"</td>
                        <td>Quick (çŸ¥è¯†åº“ä¼˜å…ˆ)</td>
                    </tr>
                    <tr>
                        <td><code>medicine_info</code></td>
                        <td>è¯å“ä¿¡æ¯</td>
                        <td>"å¸ƒæ´›èŠ¬çš„ç”¨æ³•"</td>
                        <td>Quick (çŸ¥è¯†åº“ä¼˜å…ˆ)</td>
                    </tr>
                    <tr>
                        <td><code>hospital_recommend</code></td>
                        <td>åŒ»é™¢æ¨è</td>
                        <td>"åŒ—äº¬çœ‹å¿ƒå†…ç§‘å“ªå®¶å¥½"</td>
                        <td>Quick (Web æœç´¢)</td>
                    </tr>
                    <tr>
                        <td><code>health_advice</code></td>
                        <td>å¥åº·å»ºè®®</td>
                        <td>"å¦‚ä½•æ”¹å–„ç¡çœ "</td>
                        <td>Quick (çŸ¥è¯†åº“ä¼˜å…ˆ)</td>
                    </tr>
                    <tr>
                        <td><code>general_qa</code></td>
                        <td>é€šç”¨é—®ç­”</td>
                        <td>"ä½ å¥½"ã€"è°¢è°¢"</td>
                        <td>Quick (çº¯ LLM)</td>
                    </tr>
                    <tr>
                        <td><code>emergency</code></td>
                        <td>ç´§æ€¥æƒ…å†µ</td>
                        <td>"èƒ¸é—·ã€å‘¼å¸å›°éš¾"</td>
                        <td>ReAct (å¼ºåˆ¶)</td>
                    </tr>
                </tbody>
            </table>

            <h4>è·¯ç”±å†³ç­–é€»è¾‘</h4>
            <pre><code class="language-typescript">function determineRoute(intents, primaryIntent, riskIndicators): 'quick' | 'react' {
  // 1. ç´§æ€¥æƒ…å†µ â†’ ReAct
  if (primaryIntent === 'emergency' || riskIndicators.hasEmergencyKeywords) {
    return 'react';
  }

  // 2. é«˜é£é™© (severity: 'severe') â†’ ReAct
  if (riskIndicators.severity === 'severe') {
    return 'react';
  }

  // 3. å¤šæ„å›¾ â†’ ReAct
  if (intents.length > 1) {
    return 'react';
  }

  // 4. å•æ„å›¾ + ä½é£é™© â†’ Quick
  return 'quick';
}</code></pre>
        </div>

        <!-- 5.3 å·¥å…·ç³»ç»Ÿ -->
        <div class="card">
            <h3>5.3 å·¥å…·ç³»ç»Ÿ (Tool System)</h3>
            <p>Agent å½“å‰æ”¯æŒ <strong>4 ä¸ªæ ¸å¿ƒå·¥å…· (P0)</strong>ï¼š</p>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TB
    subgraph "P0 æ ¸å¿ƒå·¥å…·"
        T1[ğŸ“š query_knowledge_base<br/>çŸ¥è¯†åº“æŸ¥è¯¢]
        T2[ğŸŒ search_web<br/>è”ç½‘æœç´¢]
        T3[â“ ask_followup_question<br/>è¿½é—®ç”¨æˆ·]
        T4[âœ… finish<br/>ç»“æŸå¯¹è¯]
    end

    subgraph "è§„åˆ’ä¸­ - P1/P2"
        T5[âš ï¸ assess_risk<br/>é£é™©è¯„ä¼°]
        T6[ğŸ¥ recommend_hospital<br/>åŒ»é™¢æ¨è]
        T7[ğŸ“· analyze_image<br/>å›¾ç‰‡åˆ†æ]
    end

    style T1 fill:#dbeafe,stroke:#2563eb
    style T2 fill:#dcfce7,stroke:#10b981
    style T3 fill:#fef3c7,stroke:#f59e0b
    style T4 fill:#f3e8ff,stroke:#7c3aed
                </pre>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>å·¥å…·åç§°</th>
                        <th>åŠŸèƒ½æè¿°</th>
                        <th>å…¸å‹è¾“å…¥</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>query_knowledge_base</code></td>
                        <td>æŸ¥è¯¢ Coze åŒ»ç–—çŸ¥è¯†åº“</td>
                        <td><code>{ query: "æ„Ÿå†’ç—‡çŠ¶" }</code></td>
                    </tr>
                    <tr>
                        <td><code>search_web</code></td>
                        <td>è°ƒç”¨ Tavily è”ç½‘æœç´¢</td>
                        <td><code>{ query: "åå’ŒåŒ»é™¢å¿ƒå†…ç§‘ä¸“å®¶" }</code></td>
                    </tr>
                    <tr>
                        <td><code>ask_followup_question</code></td>
                        <td>å‘ç”¨æˆ·è¿½é—®æ›´å¤šä¿¡æ¯</td>
                        <td><code>{ question: "è¯·é—®ç—‡çŠ¶æŒç»­å¤šä¹…äº†ï¼Ÿ" }</code></td>
                    </tr>
                    <tr>
                        <td><code>finish</code></td>
                        <td>ç”Ÿæˆæœ€ç»ˆå›å¤å¹¶ç»“æŸ</td>
                        <td><code>{ summary: "æ ¹æ®æ‚¨çš„æè¿°..." }</code></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <div class="section-divider"></div>

    <!-- 06. æ¶ˆæ¯åè®® -->
    <section>
        <h2>06. æ¶ˆæ¯åè®®ä¸äº‹ä»¶ç³»ç»Ÿ (Message Protocol)</h2>

        <!-- 6.1 SSE äº‹ä»¶æµ -->
        <div class="card">
            <h3>6.1 SSE äº‹ä»¶æµæ¶æ„</h3>
            <p>å‰åç«¯é€šè¿‡ <strong>Server-Sent Events (SSE)</strong> å®ç°å®æ—¶é€šä¿¡ï¼š</p>

            <div class="mermaid-container">
                <pre class="mermaid">
sequenceDiagram
    participant F as Frontend
    participant B as Backend
    participant A as Agent
    participant T as Tools

    F->>B: POST /api/ai-chat/stream
    B->>A: createAgentGraph().invoke()

    A->>A: classifyIntent
    A-->>B: agent:intent äº‹ä»¶

    alt Quick é€šé“
        A->>T: queryKnowledgeBase
        T-->>A: ç»“æœ
        A-->>B: tool:call (running/completed)
        A->>A: LLM ç”Ÿæˆ
        A-->>B: message:content (æµå¼)
    else ReAct å¾ªç¯
        loop æœ€å¤š 5 æ¬¡
            A->>A: Think
            A->>T: å·¥å…·è°ƒç”¨
            T-->>A: Observation
            A-->>B: tool:call äº‹ä»¶
        end
        A-->>B: message:content (æµå¼)
    end

    A-->>B: message:metadata
    A-->>B: conversation:end
    B-->>F: SSE äº‹ä»¶æµ
                </pre>
            </div>
        </div>

        <!-- 6.2 äº‹ä»¶ç±»å‹ -->
        <div class="card">
            <h3>6.2 äº‹ä»¶ç±»å‹å®šä¹‰</h3>
            <p>ç³»ç»Ÿå®šä¹‰äº† <strong>7 ç§æ ¸å¿ƒäº‹ä»¶ç±»å‹</strong>ï¼š</p>

            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 20px 0;">
                <span class="event-type event-status">conversation:status</span>
                <span class="event-type event-status">message:status</span>
                <span class="event-type event-content">message:content</span>
                <span class="event-type event-metadata">message:metadata</span>
                <span class="event-type event-tool">tool:call</span>
                <span class="event-type event-error">error</span>
                <span class="event-type event-status">conversation:end</span>
            </div>

            <!-- Tabs for event examples -->
            <div class="tabs">
                <button class="tab active" onclick="showTab(event, 'tab-content')">message:content</button>
                <button class="tab" onclick="showTab(event, 'tab-tool')">tool:call</button>
                <button class="tab" onclick="showTab(event, 'tab-metadata')">message:metadata</button>
                <button class="tab" onclick="showTab(event, 'tab-end')">conversation:end</button>
            </div>

            <div id="tab-content" class="tab-content active">
                <pre><code class="language-typescript">// æ¶ˆæ¯å†…å®¹äº‹ä»¶ï¼ˆæµå¼è¾“å‡ºï¼‰
interface MessageContentEvent {
  eventId: string;           // "evt_1706512345_abc123"
  type: 'message:content';
  data: {
    conversationId: string;  // "conv-xxx"
    messageId: string;       // "msg-xxx"
    delta: string;           // "æ ¹æ®æ‚¨çš„æè¿°..."ï¼ˆå¢é‡å†…å®¹ï¼‰
    index: number;           // 0, 1, 2...
    isFirst: boolean;        // trueï¼ˆé¦–ä¸ªåˆ†ç‰‡ï¼‰
    isLast: boolean;         // false
    timestamp: string;       // ISO æ—¶é—´æˆ³
  };
}</code></pre>
            </div>

            <div id="tab-tool" class="tab-content">
                <pre><code class="language-typescript">// å·¥å…·è°ƒç”¨äº‹ä»¶
interface ToolCallEvent {
  eventId: string;
  type: 'tool:call';
  data: {
    conversationId: string;
    toolId: string;          // "tool-search_web-1"
    toolName: string;        // "search_web"
    messageId: string;
    status: 'pending' | 'running' | 'completed' | 'failed';
    input?: {
      query: string;         // å·¥å…·è¾“å…¥å‚æ•°
    };
    output?: {
      hasResults: boolean;
      sources: Array<{ title: string; url: string; content: string }>;
    };
    error?: string;          // å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯
    duration?: number;       // æ‰§è¡Œè€—æ—¶ (ms)
    iteration?: number;      // ReAct å¾ªç¯è¿­ä»£æ¬¡æ•°
    timestamp: string;
  };
}</code></pre>
            </div>

            <div id="tab-metadata" class="tab-content">
                <pre><code class="language-typescript">// æ¶ˆæ¯å…ƒæ•°æ®äº‹ä»¶
interface MessageMetadataEvent {
  eventId: string;
  type: 'message:metadata';
  data: {
    conversationId: string;
    messageId: string;
    sources?: Array<{           // ä¿¡æ¯æ¥æº
      title: string;
      url: string;
      snippet: string;
    }>;
    actions?: Array<{           // æ¨èæ“ä½œ
      type: 'recommend_doctor' | 'transfer_to_doctor' | 'book_appointment';
      label: string;            // "æ¨èåŒ»ç”Ÿï¼šå¼ ä¸‰"
      data?: {
        doctorId: string;
        doctorName: string;
        hospital: string;
        department: string;
      };
    }>;
    medicalAdvice?: {           // åŒ»ç–—å»ºè®®
      symptoms: string[];
      possibleConditions: string[];
      suggestions: string[];
      urgencyLevel: 'low' | 'medium' | 'high';
    };
    toolsUsed?: string[];       // ä½¿ç”¨çš„å·¥å…·åˆ—è¡¨
    timestamp: string;
  };
}</code></pre>
            </div>

            <div id="tab-end" class="tab-content">
                <pre><code class="language-typescript">// ä¼šè¯ç»“æŸäº‹ä»¶
interface ConversationEndEvent {
  eventId: string;
  type: 'conversation:end';
  data: {
    conversationId: string;
    messageId: string;
    duration: number;        // ä¼šè¯è€—æ—¶ (ms)
    messageCount: number;    // æ¶ˆæ¯æ€»æ•°
    timestamp: string;
  };
}</code></pre>
            </div>
        </div>

        <!-- 6.3 åç«¯äº‹ä»¶å‘å°„å™¨ -->
        <div class="card">
            <h3>6.3 åç«¯äº‹ä»¶å‘å°„å™¨ (AgentEventEmitter)</h3>
            <p>åç«¯é€šè¿‡ <code>AgentEventEmitter</code> ç±»ç»Ÿä¸€ç®¡ç†äº‹ä»¶å‘å°„ï¼š</p>

            <pre><code class="language-typescript">// backend/src/agent/events/AgentEventEmitter.ts
class AgentEventEmitter extends EventEmitter {
  // å‘å°„æ„å›¾è¯†åˆ«äº‹ä»¶
  emitIntent(intent: UserIntent, entities: Record<string, any>): void;

  // å‘å°„å·¥å…·è°ƒç”¨äº‹ä»¶
  emitToolCall(
    tool: ToolType,
    status: 'running' | 'completed' | 'failed',
    details?: { input?: any; output?: any; error?: string }
  ): void;

  // å‘å°„æ¶ˆæ¯å†…å®¹ï¼ˆæµå¼ï¼‰
  emitContent(delta: string): void;

  // å‘å°„å…ƒæ•°æ®
  emitMetadata(metadata: { sources?: any[]; actions?: any[] }): void;

  // å‘å°„å®Œæˆäº‹ä»¶
  emitDone(conversationId: string, messageId?: string): void;

  // å‘å°„é”™è¯¯äº‹ä»¶
  emitError(error: string, code?: string): void;
}</code></pre>
        </div>
    </section>

    <div class="section-divider"></div>

    <!-- 07. å‰ç«¯çŠ¶æ€ç®¡ç† -->
    <section>
        <h2>07. å‰ç«¯çŠ¶æ€ç®¡ç†æ¶æ„ (Frontend State)</h2>

        <!-- 7.1 MobX æ¶æ„ -->
        <div class="card">
            <h3>7.1 MobX + Entity View æ¶æ„</h3>
            <p>å‰ç«¯ä½¿ç”¨ <strong>MobX</strong> è¿›è¡Œå“åº”å¼çŠ¶æ€ç®¡ç†ï¼Œæ ¸å¿ƒæ¨¡å‹ç±»ï¼š</p>

            <div class="mermaid-container">
                <pre class="mermaid">
classDiagram
    class Conversation {
        +string conversationId
        +ConversationItem[] items
        +string status
        +sendMessage(content, imageUrls)
        +loadFromHistory()
        -handleSSEEvent()
    }

    class ConversationItem {
        +string id
        +Date timestamp
        +string role
    }
    note for ConversationItem "Abstract base class"

    class UserMessage {
        +string content
        +Attachment[] attachments
    }

    class AgentResponse {
        +AgentView view
        +boolean isComplete
        +markComplete()
    }

    class AgentView {
        +Event[] events
        +EventGroup[] groups
        +handleSSEEvent(sseEvent)
        +hasRunningTools()
        +getFullMessageContent()
    }

    class Event {
        +string id
        +string type
        +update(data)
    }
    note for Event "Abstract base class"

    Conversation "1" --> "*" ConversationItem : items
    ConversationItem <|-- UserMessage
    ConversationItem <|-- AgentResponse
    AgentResponse "1" --> "1" AgentView : view
    AgentView "1" --> "*" Event : events
    Event <|-- MessageContentEvent
    Event <|-- ToolCallEvent
    Event <|-- MessageMetadataEvent
                </pre>
            </div>
        </div>

        <!-- 7.2 äº‹ä»¶å¤„ç†æµç¨‹ -->
        <div class="card">
            <h3>7.2 SSE äº‹ä»¶å¤„ç†æµç¨‹</h3>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart LR
    subgraph "SSE Client"
        SSE[fetch + EventSourceParser] --> RAW[RawSSEEvent]
    end

    subgraph "Conversation"
        RAW --> CONV[handleSSEEvent]
        CONV --> |conversation_end| COMPLETE[markComplete]
        CONV --> |å…¶ä»–äº‹ä»¶| VIEW[AgentView.handleSSEEvent]
    end

    subgraph "AgentView"
        VIEW --> FACTORY[EventFactory.createFromSSE]
        FACTORY --> |message_content| UPDATE[æ›´æ–°ç°æœ‰ / åˆ›å»ºæ–°]
        FACTORY --> |tool_call| REPLACE[æ›¿æ¢ç°æœ‰ / åˆ›å»ºæ–°]
        FACTORY --> |å…¶ä»–| ADD[ç›´æ¥æ·»åŠ ]
    end

    subgraph "React æ¸²æŸ“"
        UPDATE --> GROUPS[computed: groups]
        REPLACE --> GROUPS
        ADD --> GROUPS
        GROUPS --> RENDER[AgentViewRenderer]
    end

    style SSE fill:#dbeafe
    style CONV fill:#dcfce7
    style VIEW fill:#fef3c7
    style RENDER fill:#f3e8ff
                </pre>
            </div>

            <h4>å…³é”®ä»£ç ï¼šAgentView.handleSSEEvent</h4>
            <pre><code class="language-typescript">@action
handleSSEEvent(sseEvent: SSEEvent): void {
  // 1. message_content ç‰¹æ®Šå¤„ç†ï¼ˆæµå¼ç´¯åŠ ï¼‰
  if (sseEvent.type === 'message_content') {
    const existingIndex = this.events.findIndex(
      e => e.id === sseEvent.data.messageId
    );
    if (existingIndex >= 0) {
      // æ›´æ–°ç°æœ‰æ¶ˆæ¯ï¼šè¿½åŠ  delta
      (this.events[existingIndex] as MessageContentEvent).update({
        delta: sseEvent.data.delta,
        isLast: sseEvent.data.isLast,
      });
    } else {
      // åˆ›å»ºæ–°æ¶ˆæ¯
      this.events.push(EventFactory.createFromSSE(sseEvent));
    }
    return;
  }

  // 2. tool_call ç‰¹æ®Šå¤„ç†ï¼ˆçŠ¶æ€æ›´æ–°/æ›¿æ¢ï¼‰
  if (sseEvent.type === 'tool_call') {
    const existingIndex = this.events.findIndex(
      e => (e as ToolCallEvent).toolId === sseEvent.data.toolId
    );
    if (existingIndex >= 0) {
      // æ›¿æ¢ä¸ºæ–°çš„ ToolCallEvent å¯¹è±¡
      this.events[existingIndex] = new ToolCallEvent({
        ...existingEvent,
        status: sseEvent.data.status,
        output: sseEvent.data.output,
      });
    } else {
      this.events.push(EventFactory.createFromSSE(sseEvent));
    }
    return;
  }

  // 3. å…¶ä»–äº‹ä»¶ï¼šç›´æ¥æ·»åŠ 
  const newEvent = EventFactory.createFromSSE(sseEvent);
  if (newEvent) this.events.push(newEvent);
}</code></pre>
        </div>

        <!-- 7.3 åˆ†ç»„æ¸²æŸ“ -->
        <div class="card">
            <h3>7.3 äº‹ä»¶åˆ†ç»„ä¸ UI æ¸²æŸ“</h3>
            <p><code>AgentView.groups</code> è®¡ç®—å±æ€§å°†äº‹ä»¶åˆ†ç»„ä¸ºæ¸²æŸ“å•å…ƒï¼š</p>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TB
    subgraph "åŸå§‹äº‹ä»¶æµ"
        E1[thinking] --> E2[tool_call: running]
        E2 --> E3[tool_call: completed]
        E3 --> E4[message_content]
        E4 --> E5[message_content]
        E5 --> E6[message_metadata]
    end

    subgraph "åˆ†ç»„ç»“æœ"
        G1[thinking ç»„]
        G2[tool_group ç»„<br/>E2, E3]
        G3[content ç»„<br/>E4, E5]
        G4[metadata ç»„]
    end

    E1 -.-> G1
    E2 -.-> G2
    E3 -.-> G2
    E4 -.-> G3
    E5 -.-> G3
    E6 -.-> G4

    subgraph "æ¸²æŸ“ç»„ä»¶"
        R1[ThinkingRenderer]
        R2[ToolGroup<br/>å¯æŠ˜å ]
        R3[MarkdownRenderer]
        R4[MetadataRenderer<br/>Actions / Cards]
    end

    G1 --> R1
    G2 --> R2
    G3 --> R3
    G4 --> R4
                </pre>
            </div>
        </div>
    </section>

    <div class="section-divider"></div>

    <!-- 08. æ€»ç»“ -->
    <section>
        <h2>08. æŠ€æœ¯æ ˆæ€»ç»“</h2>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>å±‚çº§</th>
                        <th>æŠ€æœ¯é€‰å‹</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>AI Agent</strong></td>
                        <td>LangGraph + DeepSeek</td>
                        <td>çŠ¶æ€å›¾ç¼–æ’ã€æ„å›¾åˆ†ç±»ã€ReAct å¾ªç¯</td>
                    </tr>
                    <tr>
                        <td><strong>åç«¯æ¡†æ¶</strong></td>
                        <td>Hono + Node.js</td>
                        <td>è½»é‡çº§ Web æ¡†æ¶ï¼ŒSSE æµå¼å“åº”</td>
                    </tr>
                    <tr>
                        <td><strong>æ•°æ®åº“</strong></td>
                        <td>Supabase (PostgreSQL)</td>
                        <td>å¯¹è¯å†å²ã€ç”¨æˆ·æ•°æ®æŒä¹…åŒ–</td>
                    </tr>
                    <tr>
                        <td><strong>å‰ç«¯æ¡†æ¶</strong></td>
                        <td>React + MobX</td>
                        <td>å“åº”å¼çŠ¶æ€ç®¡ç†ã€Entity View æ¨¡å¼</td>
                    </tr>
                    <tr>
                        <td><strong>é€šä¿¡åè®®</strong></td>
                        <td>SSE (Server-Sent Events)</td>
                        <td>å®æ—¶æµå¼è¾“å‡ºã€äº‹ä»¶æ¨é€</td>
                    </tr>
                    <tr>
                        <td><strong>å·¥å…·é›†æˆ</strong></td>
                        <td>Tavily Search + Coze KB</td>
                        <td>è”ç½‘æœç´¢ã€åŒ»ç–—çŸ¥è¯†åº“æŸ¥è¯¢</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <div class="footer">
        <p>Xiaohe AI Doctor Project Presentation Â· Technical Deep Dive</p>
        <p style="font-size: 0.8rem; margin-top: 5px;">Powered by Mermaid.js & Highlight.js</p>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#dbeafe',
                primaryTextColor: '#1e40af',
                primaryBorderColor: '#2563eb',
                lineColor: '#64748b',
                secondaryColor: '#dcfce7',
                tertiaryColor: '#f8fafc'
            },
            flowchart: {
                curve: 'basis',
                padding: 20
            },
            sequence: {
                actorMargin: 50,
                messageMargin: 30
            }
        });

        // Initialize Highlight.js
        hljs.highlightAll();

        // Tab switching
        function showTab(event, tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });

            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(el => {
                el.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabId).classList.add('active');

            // Activate clicked tab
            event.target.classList.add('active');

            // Re-highlight code in the newly visible tab
            hljs.highlightAll();
        }
    </script>
</body>
</html>
