# å°è·AIåŒ»ç”Ÿ - å‰ç«¯

åŸºäº React + TypeScript + Vite çš„ H5 åŒ»ç–—å’¨è¯¢åº”ç”¨ã€‚

## åŠŸèƒ½ç‰¹æ€§

### AI å¥åº·åŠ©æ‰‹
- âœ… æ™ºèƒ½ç—‡çŠ¶åˆ†æ
- âœ… è¯å“æŸ¥è¯¢è¯†åˆ«
- âœ… åŒ»é™¢ç§‘å®¤æ¨è
- âœ… é€šç”¨åŒ»ç–—é—®ç­”
- âœ… **å›¾ç‰‡ä¸Šä¼ ** - æ”¯æŒä¸Šä¼ åŒ»ç–—å›¾ç‰‡ï¼ˆç—‡çŠ¶ç…§ç‰‡ã€è¯å“å›¾ç‰‡ã€æ£€æŸ¥æŠ¥å‘Šç­‰ï¼‰
- âœ… **å¤šæ¨¡æ€è¯†åˆ«** - æ™ºè°± GLM-4V å›¾ç‰‡ç†è§£
- âœ… **çŸ¥è¯†åº“å¢å¼º** - Coze çŸ¥è¯†åº“æŸ¥è¯¢
- âœ… **ç½‘ç»œæœç´¢** - Tavily å®æ—¶ä¿¡æ¯æ£€ç´¢
- âœ… **å·¥å…·åé¦ˆ** - å®æ—¶å±•ç¤º AI å·¥å…·è°ƒç”¨è¿‡ç¨‹ï¼ˆè¯†åˆ«ã€æŸ¥è¯¢ã€æœç´¢ï¼‰

### ä¸“å®¶é—®è¯Š
- âœ… åœ¨çº¿å®æ—¶å’¨è¯¢
- âœ… WebSocket å®æ—¶é€šä¿¡
- âœ… æ¶ˆæ¯å·²è¯»çŠ¶æ€
- âœ… åŒ»ç”Ÿåˆ—è¡¨æµè§ˆ

### é¢„çº¦æŒ‚å·
- âœ… åŒ»ç”Ÿæ’ç­ç®¡ç†
- âœ… åœ¨çº¿é¢„çº¦
- âœ… é¢„çº¦è®°å½•æŸ¥è¯¢

---

## å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½

### ä½¿ç”¨æ–¹å¼

1. ç‚¹å‡»èŠå¤©è¾“å…¥æ¡†å³ä¾§çš„å›¾ç‰‡å›¾æ ‡
2. é€‰æ‹©å›¾ç‰‡ï¼ˆæ”¯æŒ JPGã€PNGã€GIFã€WebPï¼Œæœ€å¤§ 5MBï¼‰
3. ä¸Šä¼ æˆåŠŸåæ˜¾ç¤ºé¢„è§ˆï¼Œå¯åˆ é™¤é‡æ–°ä¸Šä¼ 
4. è¾“å…¥æè¿°æ–‡å­—ï¼ˆå¯é€‰ï¼‰å¹¶ç‚¹å‡»å‘é€
5. AI å°†ç»“åˆå›¾ç‰‡å’Œæ–‡å­—è¿›è¡Œå¤šæ¨¡æ€åˆ†æ

### å·¥å…·åé¦ˆå±•ç¤º

AI å¤„ç†æ¶ˆæ¯æ—¶ï¼Œä¼šå®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨å¡ç‰‡ï¼š
- ğŸ–¼ï¸ **å›¾ç‰‡è¯†åˆ«** - ä½¿ç”¨æ™ºè°± GLM-4V è¯†åˆ«å›¾ç‰‡å†…å®¹
- ğŸ“š **çŸ¥è¯†åº“æŸ¥è¯¢** - ä» Coze çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³ä¿¡æ¯
- ğŸ” **ç½‘ç»œæœç´¢** - ä½¿ç”¨ Tavily æœç´¢æœ€æ–°åŒ»ç–—èµ„è®¯

æ¯ä¸ªå·¥å…·æ˜¾ç¤ºçŠ¶æ€ï¼ˆè¿›è¡Œä¸­/å®Œæˆ/å¤±è´¥ï¼‰å’Œè€—æ—¶ã€‚

### æ¶ˆæ¯æ˜¾ç¤º

- **çº¯æ–‡å­—æ¶ˆæ¯**ï¼šæ ‡å‡†æ–‡æœ¬æ°”æ³¡
- **çº¯å›¾ç‰‡æ¶ˆæ¯**ï¼šå›¾ç‰‡å±•ç¤ºåœ¨æ°”æ³¡ä¸­
- **æ··åˆæ¶ˆæ¯**ï¼šå›¾ç‰‡åœ¨ä¸Šæ–¹ï¼Œæ–‡å­—åœ¨ä¸‹æ–¹
- å›¾ç‰‡æœ€å¤§é«˜åº¦ 200pxï¼Œè‡ªé€‚åº”å®½åº¦
- å›¾ç‰‡åŠ è½½å¤±è´¥æ˜¾ç¤ºå ä½ç¬¦

---

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: React 18 + TypeScript
- **æ„å»ºå·¥å…·**: Vite
- **è·¯ç”±**: React Router v6
- **çŠ¶æ€ç®¡ç†**: XState (æœ‰é™çŠ¶æ€æœº)
- **æ ·å¼**: Tailwind CSS
- **å›¾æ ‡**: Lucide React
- **é€šçŸ¥**: react-hot-toast
- **é€šä¿¡**: SSE (Server-Sent Events)
- **æµ‹è¯•**: Vitest + React Testing Library

---

## å¼€å‘æŒ‡å—

### å®‰è£…ä¾èµ–

```bash
pnpm install
```

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm run dev
```

è®¿é—® http://localhost:5173

### æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
pnpm run build
```

### è¿è¡Œæµ‹è¯•

```bash
pnpm run test
```

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
VITE_API_BASE_URL=http://localhost:3000
```

---

## é¡¹ç›®ç»“æ„

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/          # å¯å¤ç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ message/         # æ¶ˆæ¯ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageRenderer.tsx     # æ¶ˆæ¯æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â””â”€â”€ ToolCallCard.tsx        # å·¥å…·è°ƒç”¨å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ upload/          # ä¸Šä¼ ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ ImageUploader.tsx       # å›¾ç‰‡ä¸Šä¼ ç»„ä»¶
â”‚   â”‚   â””â”€â”€ doctor/          # åŒ»ç”Ÿç«¯ç»„ä»¶
â”‚   â”œâ”€â”€ pages/               # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Chat.tsx         # AI èŠå¤©é¡µé¢
â”‚   â”‚   â”œâ”€â”€ Home.tsx         # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ Appointments/    # é¢„çº¦ç›¸å…³é¡µé¢
â”‚   â”‚   â””â”€â”€ doctor/          # åŒ»ç”Ÿç«¯é¡µé¢
â”‚   â”œâ”€â”€ machines/            # XState çŠ¶æ€æœº
â”‚   â”‚   â””â”€â”€ chatMachine.ts   # èŠå¤©çŠ¶æ€æœº
â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ sseClient.ts     # SSE å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ websocket.ts     # WebSocket å®¢æˆ·ç«¯
â”‚   â””â”€â”€ App.tsx              # æ ¹ç»„ä»¶
â”œâ”€â”€ public/                  # é™æ€èµ„æº
â””â”€â”€ package.json
```

---

## æ ¸å¿ƒæŠ€æœ¯å®ç°

### SSE æµå¼é€šä¿¡

ä½¿ç”¨ POST è¯·æ±‚ + EventSource Parser å®ç°ï¼š

```typescript
// å‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒå›¾ç‰‡ï¼‰
const client = sseClientManager.createClient({
  url: '/api/ai-chat/stream',
  method: 'POST',
  conversationId: 'conv_123',
  message: 'è¿™æ˜¯ä»€ä¹ˆè¯ï¼Ÿ',
  imageUrls: ['https://example.com/medicine.jpg'],
  onEvent: (event) => {
    // å¤„ç†æµå¼äº‹ä»¶
  },
});
```

### çŠ¶æ€æœºç®¡ç†

ä½¿ç”¨ XState ç®¡ç†èŠå¤©çŠ¶æ€ï¼š

```typescript
const [state, send] = useMachine(chatMachine);

// å‘é€æ¶ˆæ¯
send({ 
  type: 'SEND_MESSAGE', 
  content: 'æˆ‘å¤´ç—›',
  imageUrls: ['https://...'] 
});

// ç›‘å¬çŠ¶æ€
state.matches('streaming'); // æ˜¯å¦æ­£åœ¨æ¥æ”¶å›å¤
```

### æ¶ˆæ¯åè®®

#### ç”¨æˆ·æ¶ˆæ¯

```typescript
interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;              // æ–‡å­—å†…å®¹
  imageUrls?: string[];          // å›¾ç‰‡ URL æ•°ç»„ï¼ˆæœ€å¤š1å¼ ï¼‰
  timestamp: string;
  status: 'pending' | 'sending' | 'streaming' | 'complete' | 'failed';
}
```

#### SSE äº‹ä»¶ç±»å‹

- `conversation:status` - å¯¹è¯çŠ¶æ€å˜æ›´
- `message:status` - æ¶ˆæ¯çŠ¶æ€å˜æ›´
- `message:content` - æµå¼å†…å®¹ï¼ˆdeltaï¼‰
- `message:metadata` - æ¶ˆæ¯å…ƒæ•°æ®ï¼ˆåŒ»ç–—å»ºè®®ç­‰ï¼‰
- `tool:call` - å·¥å…·è°ƒç”¨çŠ¶æ€ï¼ˆè¯†åˆ«ã€æŸ¥è¯¢ã€æœç´¢ï¼‰
- `conversation:end` - å¯¹è¯ç»“æŸ

---

## å¸¸è§é—®é¢˜

### å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Ÿ

1. æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡ 5MB
2. ç¡®è®¤æ–‡ä»¶æ ¼å¼ï¼ˆä»…æ”¯æŒ JPGã€PNGã€GIFã€WebPï¼‰
3. ç¡®è®¤å·²ç™»å½•ï¼ˆéœ€è¦ Bearer Tokenï¼‰
4. æ£€æŸ¥ Supabase Storage é…ç½®

### SSE è¿æ¥å¤±è´¥ï¼Ÿ

1. ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
2. æ£€æŸ¥ VITE_API_BASE_URL é…ç½®
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ç½‘ç»œè¯·æ±‚
4. ç¡®è®¤åç«¯è·¯ç”±å·²æ”¹ä¸º POST

### å·¥å…·å¡ç‰‡ä¸æ˜¾ç¤ºï¼Ÿ

1. ç¡®è®¤åç«¯ Agent æ­£ç¡®å‘é€ `tool:call` äº‹ä»¶
2. æ£€æŸ¥ `chatMachine` çš„ `toolCalls` çŠ¶æ€
3. ç¡®è®¤ MessagesList æ­£ç¡®ä¼ é€’ `toolCalls` prop

---

## è´¡çŒ®æŒ‡å—

1. éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒï¼ˆå‚è€ƒæ ¹ç›®å½• CLAUDE.mdï¼‰
2. ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
3. ç»„ä»¶ä½¿ç”¨å‡½æ•°å¼ + Hooks
4. çŠ¶æ€ç®¡ç†ä¼˜å…ˆä½¿ç”¨ XState
5. æ ·å¼ä½¿ç”¨ Tailwind CSS
6. æäº¤å‰è¿è¡Œ `pnpm run build` ç¡®ä¿æ— é”™è¯¯

---

## è”ç³»æ–¹å¼

é¡¹ç›®æ–‡æ¡£ï¼š`docs/plans/`
è®¾è®¡æ–‡æ¡£ï¼š
- `2026-01-27-ai-chat-image-upload-design.md` - å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½è®¾è®¡
- `2026-01-25-frontend-design.md` - å‰ç«¯æ•´ä½“è®¾è®¡

æŠ€æœ¯æ”¯æŒï¼šå‚è€ƒåç«¯ README.md
