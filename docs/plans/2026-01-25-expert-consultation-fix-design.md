# ä¸“å®¶ä¼šè¯ŠåŠŸèƒ½ä¼˜åŒ–è®¾è®¡æ–‡æ¡£

**æ¨¡å—åç§°**: ä¸“å®¶ä¼šè¯ŠåŠŸèƒ½ä¼˜åŒ–
**åˆ›å»ºæ—¥æœŸ**: 2026-01-25
**ç‰ˆæœ¬**: v1.1

---

## é—®é¢˜èƒŒæ™¯

å½“å‰ä¸“å®¶ä¼šè¯ŠåŠŸèƒ½å­˜åœ¨ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. **ä¸“å®¶æ— æ³•æå‰çœ‹åˆ°ç”¨æˆ·é—®é¢˜**ï¼šä¸“å®¶åœ¨æœªè¿›å…¥ä¼šè¯æ—¶æ— æ³•çœ‹åˆ°ç”¨æˆ·å·²ç»å‘é€çš„é—®é¢˜ï¼Œåªæœ‰éƒ½è¿›å…¥äº†ä¼šè¯æ‰èƒ½è¿›è¡Œä¼šè¯
2. **å›å¤åé—®è¯Šæ¶ˆå¤±**ï¼šåªè¦ä¸“å®¶å›å¤äº†ï¼Œå¾…è¯Šåˆ—è¡¨é‡Œå°±æ¶ˆå¤±äº†ï¼Œè¿™éå¸¸ä¸åˆç†

---

## æ•´ä½“è®¾è®¡æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹åŠ¨

| æ”¹åŠ¨é¡¹ | è¯´æ˜ |
|-------|------|
| æ•°æ®æ¨¡å‹æ‰©å±• | Consultation å¢åŠ  `lastMessage`ã€`lastMessageTime` å­—æ®µ |
| æ–°å¢æ¶ˆæ¯å­˜å‚¨ | åˆ›å»º `messageStore.ts` å­˜å‚¨é—®è¯Šæ¶ˆæ¯ |
| API è°ƒæ•´ | å¾…è¯Šåˆ—è¡¨ â†’ é—®è¯Šåˆ—è¡¨ï¼Œæ”¯æŒ pending/active çŠ¶æ€ç­›é€‰ |
| å‰ç«¯ UI è°ƒæ•´ | å¡ç‰‡æ˜¾ç¤ºæ¶ˆæ¯æ‘˜è¦ï¼Œæ–°å¢çŠ¶æ€ Tab |
| æƒé™è°ƒæ•´ | æ‚£è€…ä¹Ÿå¯ä»¥ç»“æŸä¼šè¯Š |

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•°æ®æ¨¡å‹å˜æ›´

### Consultation æ¥å£æ‰©å±•

```typescript
export interface Consultation {
  id: string;
  patientId: string;
  patientPhone: string;
  doctorId: string;
  status: 'pending' | 'active' | 'closed' | 'cancelled';  // æ–°å¢ cancelled
  createdAt: string;
  updatedAt: string;
  // æ–°å¢å­—æ®µ
  lastMessage?: string;       // æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹ï¼ˆç”¨äºåˆ—è¡¨æ˜¾ç¤ºï¼‰
  lastMessageTime?: string;   // æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´
}
```

### æ–°å¢ Message æ¥å£

```typescript
export interface Message {
  id: string;
  consultationId: string;
  senderId: string;
  senderType: 'patient' | 'doctor';
  content: string;
  createdAt: string;
}
```

### ä¼šè¯çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | å«ä¹‰ | è°å¯ä»¥è§¦å‘ |
|-----|------|----------|
| `pending` | å¾…æ¥è¯Š | - |
| `active` | è¿›è¡Œä¸­ | åŒ»ç”Ÿæ¥è¯Šå |
| `closed` | æ­£å¸¸ç»“æŸ | åŒ»ç”Ÿ/æ‚£è€…ä¸»åŠ¨ç»“æŸ |
| `cancelled` | æ‚£è€…å–æ¶ˆ | ä»…æ‚£è€…ï¼ˆæœªæ¥è¯Šæ—¶ï¼‰ |

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šAPI å˜æ›´

### 1. è°ƒæ•´åŒ»ç”Ÿé—®è¯Šåˆ—è¡¨ API

**æ—§ API**ï¼š`GET /api/consultations/pending` - åªè¿”å› `pending` çŠ¶æ€

**æ–° API**ï¼š`GET /api/consultations/doctor` - è¿”å›åŒ»ç”Ÿçš„æ‰€æœ‰æœªå…³é—­é—®è¯Š

```typescript
// è¯·æ±‚å‚æ•°
interface GetDoctorConsultationsQuery {
  status?: 'pending' | 'active' | 'all';  // ç­›é€‰æ¡ä»¶ï¼Œé»˜è®¤ all
}

// è¿”å›ç»“æ„
{
  code: 0,
  data: [
    {
      id: "xxx",
      patientPhone: "138****8888",
      status: "pending",           // æˆ– "active"
      lastMessage: "æˆ‘å¤´ç–¼å‘çƒ§...", // æœ€åä¸€æ¡æ¶ˆæ¯æ‘˜è¦
      lastMessageTime: "10:30",
      createdAt: "2026-01-25T10:00:00Z",
      doctor: { ... }
    }
  ]
}
```

### 2. æ–°å¢æ¶ˆæ¯å†å² API

**API**ï¼š`GET /api/consultations/:id/messages`

```typescript
// è¿”å›ç»“æ„
{
  code: 0,
  data: [
    {
      id: "msg1",
      senderId: "patient1",
      senderType: "patient",
      content: "åŒ»ç”Ÿä½ å¥½ï¼Œæˆ‘å¤´ç–¼...",
      createdAt: "2026-01-25T10:00:00Z"
    }
  ]
}
```

### 3. è°ƒæ•´ closeConsultation æƒé™

**æ—§æƒé™**ï¼šåªæœ‰åŒ»ç”Ÿå¯ä»¥ç»“æŸé—®è¯Š

**æ–°æƒé™**ï¼šæ‚£è€…å’ŒåŒ»ç”Ÿéƒ½å¯ä»¥ç»“æŸé—®è¯Š

```typescript
// æ—§ä»£ç 
if (req.user.role !== 'doctor') {
  throw new UnauthorizedError('Doctor access required');
}

// æ–°ä»£ç 
if (consultation.patientId !== req.user.userId && consultation.doctorId !== req.user.userId) {
  throw new UnauthorizedError('Access denied');
}
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå‰ç«¯é¡µé¢è®¾è®¡

### åŒ»ç”Ÿç«¯ï¼šé—®è¯Šåˆ—è¡¨

**é¡µé¢è·¯å¾„**ï¼š`/doctor/tasks`

**UI è°ƒæ•´**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† è¿”å›      æˆ‘çš„é—®è¯Š             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å…¨éƒ¨] [å¾…æ¥è¯Š] [è¿›è¡Œä¸­]         â”‚  <- æ–°å¢ç­›é€‰ Tab
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [å¾…æ¥è¯Š] ğŸ‘¤ 138****8888      â”‚ â”‚  <- çŠ¶æ€æ ‡ç­¾
â”‚ â”‚ "æˆ‘å¤´ç–¼å‘çƒ§ï¼ŒæŒç»­ä¸¤å¤©äº†..."    â”‚ â”‚  <- æ˜¾ç¤ºæœ€åæ¶ˆæ¯
â”‚ â”‚ 10:30                        â”‚ â”‚
â”‚ â”‚            [æ¥è¯Š]            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [è¿›è¡Œä¸­] ğŸ‘¤ 139****9999      â”‚ â”‚
â”‚ â”‚ "å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†"             â”‚ â”‚
â”‚ â”‚ 11:15                        â”‚ â”‚
â”‚ â”‚            [ç»§ç»­]            â”‚ â”‚  <- ç‚¹å‡»è¿›å…¥èŠå¤©
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æ ‡ç­¾æ ·å¼

| çŠ¶æ€ | æ ‡ç­¾æ–‡å­— | é¢œè‰² |
|-----|---------|------|
| `pending` | å¾…æ¥è¯Š | æ©™è‰² |
| `active` | è¿›è¡Œä¸­ | ç»¿è‰² |

### æ‚£è€…ç«¯ï¼šæ–°å¢ç»“æŸé—®è¯ŠæŒ‰é’®

**ä½ç½®**ï¼šä¸“å®¶é—®è¯ŠèŠå¤©é¡µå³ä¸Šè§’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† è¿”å›      ğŸ‘¤ å¼ åŒ»ç”Ÿ    [ç»“æŸ] â”‚ â”‚  <- æ–°å¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         èŠå¤©å†…å®¹åŒºåŸŸ...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šæ¶ˆæ¯åŒæ­¥æœºåˆ¶

### ç”¨æˆ·å‘èµ·é—®è¯Šåå³å¯å‘é€æ¶ˆæ¯

**æ–°æµç¨‹**ï¼š
1. ç”¨æˆ·åˆ›å»ºé—®è¯Š â†’ `status = 'pending'`
2. ç”¨æˆ·**ç«‹å³**å¯ä»¥å‘é€æ¶ˆæ¯ï¼ˆé€šè¿‡ WebSocketï¼‰
3. æ¶ˆæ¯å­˜å‚¨åœ¨ `messageStore` ä¸­
4. æ›´æ–° `consultation.lastMessage` å’Œ `lastMessageTime`

### åŒ»ç”Ÿæ¥è¯Šæ—¶è‡ªåŠ¨åŠ è½½å†å²æ¶ˆæ¯

**æµç¨‹**ï¼š
1. åŒ»ç”Ÿç‚¹å‡»ã€Œæ¥è¯Šã€â†’ è°ƒç”¨ `PUT /api/consultations/:id/accept`
2. å‰ç«¯ç«‹å³è°ƒç”¨ `GET /api/consultations/:id/messages` è·å–å†å²æ¶ˆæ¯
3. åŠ å…¥ WebSocket ä¼šè¯ â†’ `ws.send({ type: 'join', consultationId })`
4. æ˜¾ç¤ºå†å²æ¶ˆæ¯ + å®æ—¶æ¥æ”¶æ–°æ¶ˆæ¯

### WebSocket æ¶ˆæ¯å¤„ç†è°ƒæ•´

**æ–°å¢**ï¼šæœåŠ¡ç«¯åœ¨æ¥æ”¶æ¶ˆæ¯æ—¶åŒæ­¥æ›´æ–° `consultation.lastMessage`

```typescript
// WebSocketManager.onMessage()
if (msg.type === 'message') {
  // 1. å­˜å‚¨æ¶ˆæ¯
  messageStore.addMessage({
    id: uuid(),
    consultationId: msg.conversationId,
    senderId: userId,
    senderType: userRole,
    content: msg.content,
    createdAt: new Date().toISOString()
  });

  // 2. åŒæ­¥æ›´æ–°ä¼šè¯çš„æœ€åæ¶ˆæ¯
  consultationStore.updateLastMessage(
    msg.conversationId,
    msg.content
  );

  // 3. æ¨é€ç»™å¯¹æ–¹
  wsManager.broadcastToConversation(msg.conversationId, {
    type: 'message',
    conversationId: msg.conversationId,
    message: { ... }
  });
}
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®ç°æ­¥éª¤

### åç«¯å®ç°

1. **åˆ›å»º `messageStore.ts`**
   - æ–‡ä»¶ï¼š`backend/src/services/storage/messageStore.ts`
   - åŠŸèƒ½ï¼šæ¶ˆæ¯å¢åˆ æŸ¥ã€æŒ‰ consultationId æŸ¥è¯¢

2. **æ‰©å±• `Consultation` æ¥å£**
   - æ–‡ä»¶ï¼š`backend/src/services/storage/consultationStore.ts`
   - æ–°å¢ï¼š`lastMessage`ã€`lastMessageTime` å­—æ®µ
   - æ–°å¢ï¼š`updateLastMessage()` æ–¹æ³•

3. **åˆ›å»ºæ¶ˆæ¯å†å² API**
   - æ–‡ä»¶ï¼š`backend/src/controllers/consultationController.ts`
   - æ–°å¢ï¼š`getConsultationMessages()` æ§åˆ¶å™¨
   - è·¯ç”±ï¼š`GET /api/consultations/:id/messages`

4. **è°ƒæ•´åŒ»ç”Ÿé—®è¯Šåˆ—è¡¨ API**
   - æ–‡ä»¶ï¼š`backend/src/controllers/consultationController.ts`
   - è°ƒæ•´ï¼š`getDoctorConsultations()` æ›¿ä»£ `getPendingConsultations()`
   - æ–°å¢ï¼šstatus ç­›é€‰å‚æ•°æ”¯æŒ
   - è·¯ç”±ï¼š`GET /api/consultations/doctor`

5. **è°ƒæ•´ç»“æŸä¼šè¯æƒé™**
   - æ–‡ä»¶ï¼š`backend/src/controllers/consultationController.ts`
   - è°ƒæ•´ï¼š`closeConsultation()` æƒé™æ£€æŸ¥

6. **è°ƒæ•´ WebSocket æ¶ˆæ¯å¤„ç†**
   - æ–‡ä»¶ï¼š`backend/src/services/websocket/WebSocketManager.ts`
   - è°ƒæ•´ï¼šæ¥æ”¶æ¶ˆæ¯æ—¶æ›´æ–° `consultation.lastMessage`

### å‰ç«¯å®ç°

1. **è°ƒæ•´åŒ»ç”Ÿé—®è¯Šåˆ—è¡¨é¡µ**
   - æ–‡ä»¶ï¼š`frontend/src/pages/DoctorTasks/index.tsx`
   - è°ƒæ•´ï¼šAPI è°ƒç”¨æ”¹ä¸º `/api/consultations/doctor`
   - æ–°å¢ï¼šçŠ¶æ€ Tab ç­›é€‰ï¼ˆå…¨éƒ¨/å¾…æ¥è¯Š/è¿›è¡Œä¸­ï¼‰
   - æ–°å¢ï¼šå¡ç‰‡æ˜¾ç¤º `lastMessage` å’ŒçŠ¶æ€æ ‡ç­¾

2. **è°ƒæ•´é—®è¯ŠèŠå¤©é¡µ**
   - æ–‡ä»¶ï¼š`frontend/src/pages/DoctorChat/index.tsx`
   - æ–°å¢ï¼šæ¥è¯Šæ—¶åŠ è½½å†å²æ¶ˆæ¯
   - æ–°å¢ï¼šæ‚£è€…ç«¯ã€Œç»“æŸé—®è¯Šã€æŒ‰é’®

---

## ç¬¬å…­éƒ¨åˆ†ï¼šæµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

1. **ç”¨æˆ·æå‰å‘é€æ¶ˆæ¯**
   - ç”¨æˆ·å‘èµ·é—®è¯Šåç«‹å³å‘é€æ¶ˆæ¯
   - éªŒè¯ï¼šæ¶ˆæ¯å­˜å‚¨æˆåŠŸï¼Œ`lastMessage` æ›´æ–°

2. **åŒ»ç”ŸæŸ¥çœ‹æ¶ˆæ¯æ‘˜è¦**
   - åŒ»ç”Ÿåœ¨é—®è¯Šåˆ—è¡¨ä¸­çœ‹åˆ°ç”¨æˆ·çš„é—®é¢˜
   - éªŒè¯ï¼šå¡ç‰‡æ˜¾ç¤ºæ­£ç¡®çš„ `lastMessage`

3. **åŒ»ç”Ÿæ¥è¯ŠåŠ è½½å†å²**
   - åŒ»ç”Ÿç‚¹å‡»æ¥è¯Š
   - éªŒè¯ï¼šèŠå¤©é¡µæ˜¾ç¤ºæ‰€æœ‰å†å²æ¶ˆæ¯

4. **å›å¤åé—®è¯Šä»åœ¨åˆ—è¡¨**
   - åŒ»ç”Ÿå›å¤æ¶ˆæ¯
   - éªŒè¯ï¼šé—®è¯Šä»åœ¨åˆ—è¡¨ä¸­ï¼ŒçŠ¶æ€å˜ä¸ºã€Œè¿›è¡Œä¸­ã€

5. **æ‚£è€…ç»“æŸä¼šè¯**
   - æ‚£è€…ç‚¹å‡»ç»“æŸæŒ‰é’®
   - éªŒè¯ï¼šä¼šè¯çŠ¶æ€å˜ä¸º `closed`

### çŠ¶æ€ç­›é€‰æµ‹è¯•

1. å…¨éƒ¨ Tab â†’ æ˜¾ç¤ºæ‰€æœ‰æœªå…³é—­é—®è¯Š
2. å¾…æ¥è¯Š Tab â†’ åªæ˜¾ç¤º `pending` çŠ¶æ€
3. è¿›è¡Œä¸­ Tab â†’ åªæ˜¾ç¤º `active` çŠ¶æ€

---

## æ³¨æ„äº‹é¡¹

1. **å…¼å®¹æ€§**ï¼šä¿ç•™åŸ `GET /api/consultations/pending` API ä¸€æ®µæ—¶é—´ï¼Œé€æ­¥è¿ç§»
2. **æ¶ˆæ¯æ‘˜è¦é•¿åº¦**ï¼š`lastMessage` å»ºè®®æˆªå–å‰ 50 å­—ç¬¦ï¼Œè¶…å‡ºæ˜¾ç¤º `...`
3. **æ—¶åŒºå¤„ç†**ï¼š`lastMessageTime` éœ€è¦è½¬æ¢ä¸ºç”¨æˆ·æœ¬åœ°æ—¶é—´æ ¼å¼
4. **ç©ºæ¶ˆæ¯å¤„ç†**ï¼šå¦‚æœ `lastMessage` ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤æç¤ºè¯­

---

**æœ€åæ›´æ–°**ï¼š2026-01-25
