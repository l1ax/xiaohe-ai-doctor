# 专家问诊和预约模块 - 测试驱动开发设计文档

**创建日期**: 2026-01-26
**优先级**: P0-P1 必须修复，P2-P3 逐步完善
**状态**: 设计阶段

---

## 目录

1. [项目概述](#项目概述)
2. [核心问题分析](#核心问题分析)
3. [缺失测试场景分析](#缺失测试场景分析)
4. [测试方案架构](#测试方案架构)
5. [P0 测试用例设计](#p0-测试用例设计)
6. [P1 测试用例设计](#p1-测试用例设计)
7. [风险与应对](#风险与应对)

---

## 项目概述

小禾AI医生平台当前存在专家问诊和预约模块的功能缺陷，需要通过测试驱动开发（TDD）的方式进行系统性回归和修复。

### 测试策略

- **TDD 方式** - 先写失败的测试来暴露问题，然后修复
- **未读消息** - 暂时移除 UI 上的未读显示
- **权限隔离** - 严格路由隔离，医生完全无法访问患者端
- **排班验证** - 前后端双重验证
- **导航处理** - 智能重定向到安全页面

---

## 核心问题分析

### 已识别的5个核心问题

| 问题 | 描述 | 优先级 |
|------|------|--------|
| 排班验证失效 | 医生设置的排班限制不生效，患者仍可选择不可用时间段 | P0 |
| 未读消息功能缺陷 | 显示"未读"状态但实际功能不工作 | P2 |
| 导航404问题 | 使用 `navigate(-1)` 导致404错误 | P0 |
| 权限隔离不足 | 医生可以访问患者端页面 | P0 |
| 其他潜在问题 | 需要通过测试发现 | P1-P3 |

---

## 缺失测试场景分析

### A. 专家问诊模块（完全缺失）

#### A1. 问诊状态全流程测试（P0）
- 患者发起问诊 → 医生接单 → 聊天 → 结束问诊 → 历史记录
- 医生拒绝接单场景
- 问诊超时自动处理
- 状态实时同步（患者端看到"已接单"）

#### A2. WebSocket 通信稳定性（P0）
- 断线重连机制
- 消息发送失败后的重试
- 离线消息缓存与同步
- 心跳保活机制
- 多设备同时在线的消息同步

#### A3. 消息交互完整性（P2）
- 图片消息上传、发送、接收、显示
- 超长文本消息处理
- 特殊字符和 emoji 处理
- 消息发送进度显示
- 消息发送失败提示

#### A4. 双端协作场景（P1）
- 医生接单后，患者端实时更新状态
- 患者发送消息，医生端收到通知
- 同时打开多个问诊的状态管理
- 医生工作台统计数据实时性

### B. 预约挂号模块（完全缺失）

#### B1. 预约状态全流程（P0）
- 患者预约 → 医生确认 → 预约成功 → 就诊 → 完成
- 医生拒绝预约的处理
- 预约取消后的时间释放
- 过期预约自动处理

#### B2. 排班与预约联动（P0）
- 医生设置"不可用"后，患者端时间段应禁用
- 排班已满后的时间段显示
- 时间段冲突检测（同一时段多预约）
- 排班修改对已有预约的影响
- 批量排班后的数据一致性

#### B3. 时间边界条件（P2）
- 今天最后一分钟的时间段选择
- 跨天预约（23:00-01:00）
- 过期时间段的禁用和提示
- 时区处理（如果支持）

#### B4. 预约冲突检测（P1）
- 同一患者同时预约多个医生
- 同一时段多个患者预约同一医生
- 后端 API 的冲突检测
- 前端的冲突提示

### C. 导航与路由（关键问题）

#### C1. 导航重定向逻辑（P0）
- 使用 `navigate(-1)` 时的所有可能路径
- 从详情页返回的智能重定向
- 没有历史记录时的 fallback 处理
- 404 页面的统一处理

#### C2. 浏览器导航行为（P1）
- 前进/后退按钮
- 页面刷新后的状态恢复
- 直接 URL 访问的处理
- 浏览器返回的表单重复提交

#### C3. 跨页面数据传递（P2）
- 预约流程中的数据持久化
- 半途退出后恢复流程
- 多标签页同时操作的冲突

### D. 权限与安全（核心问题）

#### D1. 角色隔离（P0）
- 医生访问患者端所有页面（严格路由隔离）
- 患者访问医生端所有页面
- 未登录访问受保护页面
- Token 过期后的处理

#### D2. 操作权限（P1）
- 医生只能操作自己的问诊/预约
- 患者只能查看自己的数据
- 跨用户数据访问防护

#### D3. 输入安全（P3）
- XSS 攻击防护测试
- SQL 注入防护测试
- 文件上传安全测试
- 敏感信息脱敏测试

### E. 数据一致性（完全缺失）

#### E1. 并发操作（P1）
- 多患者同时预约同一时段
- 医生接单同时患者取消
- 同时发送多条消息的顺序
- 统计数据的实时准确性

#### E2. 离线与同步（P2）
- 网络断开时的操作缓存
- 网络恢复后的数据同步
- 离线消息的发送顺序
- 冲突解决机制

#### E3. 多设备同步（P2）
- 手机和电脑同时在线
- 多标签页的消息同步
- 未读消息的跨设备同步
- 退出登录的完全清理

### F. 性能与边界（部分缺失）

#### F1. 大数据量处理（P3）
- 100+ 条聊天记录的滚动性能
- 100+ 医生列表的加载
- 365 天预约日期范围
- 大图片上传和处理

#### F2. 内存与稳定性（P3）
- 长时间使用的内存泄漏
- 快速切换页面的稳定性
- 大量消息后的性能
- WebSocket 长连接稳定性

#### F3. 网络异常（P1）
- 弱网环境下的加载
- 超时处理
- 网络切换（WiFi ↔ 4G）

### G. 用户体验细节（完全缺失）

#### G1. 反馈与提示（P2）
- 所有操作的成功/失败提示
- 加载状态的准确显示
- 错误信息的用户友好性
- 空状态的引导操作

#### G2. 表单交互（P2）
- 防止重复提交
- 表单验证的实时性
- 保存草稿功能
- 自动保存机制

#### G3. 可访问性（P3）
- 键盘导航支持
- 屏幕阅读器支持
- 高对比度模式
- 字体大小调整

---

## 测试方案架构

### 测试文件组织结构

```
frontend/tests/e2e/
├── helpers/                          # 测试辅助函数
│   ├── auth.ts                       # 认证辅助
│   ├── consultation.ts               # 问诊辅助
│   ├── appointment.ts                # 预约辅助
│   ├── navigation.ts                 # 导航辅助
│   └── websocket.ts                  # WebSocket辅助
│
├── 01-auth/                          # 认证与权限
│   ├── login.spec.ts                 # 登录流程（已有，需增强）
│   ├── role-isolation.spec.ts        # 【P0】角色隔离测试
│   ├── token-management.spec.ts      # 【P1】Token管理测试
│   └── unauthorized-access.spec.ts   # 未授权访问（已有，需增强）
│
├── 02-consultation/                  # 专家问诊
│   ├── patient-flow.spec.ts          # 患者流程（已有，需增强）
│   ├── doctor-flow.spec.ts           # 医生流程（已有，需增强）
│   ├── consultation-lifecycle.spec.ts # 【P0】问诊完整生命周期
│   ├── websocket.spec.ts             # 【P0】WebSocket通信测试
│   ├── message-interaction.spec.ts   # 【P2】消息交互完整测试
│   └── collaboration.spec.ts         # 【P1】医患协作场景
│
├── 03-appointment/                   # 预约挂号
│   ├── patient-flow.spec.ts          # 患者流程（已有，需增强）
│   ├── doctor-flow.spec.ts           # 医生流程（已有，需增强）
│   ├── appointment-lifecycle.spec.ts # 【P0】预约完整生命周期
│   ├── schedule-validation.spec.ts   # 【P0】排班验证测试
│   ├── conflict-detection.spec.ts    # 【P1】冲突检测测试
│   └── time-management.spec.ts       # 【P2】时间边界测试
│
├── 04-navigation/                    # 导航与路由
│   ├── browser-navigation.spec.ts    # 【P1】浏览器导航行为
│   ├── redirect-logic.spec.ts        # 【P0】重定向逻辑测试
│   ├── cross-page-data.spec.ts       # 【P2】跨页面数据传递
│   └── 404-handling.spec.ts          # 【P0】404处理测试
│
├── 05-data-consistency/              # 数据一致性
│   ├── concurrent-operations.spec.ts # 【P1】并发操作测试
│   ├── offline-sync.spec.ts          # 【P2】离线同步测试
│   └── multi-device.spec.ts          # 【P2】多设备同步测试
│
├── 06-performance/                   # 性能与稳定性
│   ├── large-data.spec.ts            # 【P3】大数据量测试
│   ├── memory-leaks.spec.ts          # 【P3】内存泄漏测试
│   └── stability.spec.ts             # 稳定性测试（已有，需增强）
│
├── 07-user-experience/               # 用户体验
│   ├── feedback-prompts.spec.ts      # 【P2】反馈提示测试
│   ├── form-interaction.spec.ts      # 【P2】表单交互测试
│   └── accessibility.spec.ts         # 【P3】可访问性测试
│
└── 08-security/                      # 安全性
    ├── input-validation.spec.ts      # 【P3】输入验证安全测试
    └── data-protection.spec.ts       # 【P3】数据保护测试
```

### 测试优先级分级

**P0 - 核心业务流程（必须修复）**
1. `role-isolation.spec.ts` - 医生访问患者端问题
2. `schedule-validation.spec.ts` - 排班不生效问题
3. `redirect-logic.spec.ts` - 导航404问题
4. `consultation-lifecycle.spec.ts` - 问诊完整流程
5. `appointment-lifecycle.spec.ts` - 预约完整流程
6. `websocket.spec.ts` - WebSocket稳定性
7. `404-handling.spec.ts` - 404页面处理

**P1 - 重要功能（影响用户体验）**
1. `token-management.spec.ts` - Token管理
2. `conflict-detection.spec.ts` - 预约冲突
3. `concurrent-operations.spec.ts` - 并发操作
4. `collaboration.spec.ts` - 医患协作
5. `browser-navigation.spec.ts` - 浏览器导航
6. 网络异常处理

**P2 - 增强功能（提升质量）**
1. `message-interaction.spec.ts` - 消息交互完整性
2. `offline-sync.spec.ts` - 离线同步
3. `multi-device.spec.ts` - 多设备同步
4. `time-management.spec.ts` - 时间边界
5. `cross-page-data.spec.ts` - 跨页面数据
6. `feedback-prompts.spec.ts` - 反馈提示
7. `form-interaction.spec.ts` - 表单交互

**P3 - 边界与安全（防御性测试）**
1. `input-validation.spec.ts` - 输入安全
2. `accessibility.spec.ts` - 可访问性
3. `large-data.spec.ts` - 大数据量
4. `memory-leaks.spec.ts` - 内存泄漏

---

## P0 测试用例设计

### 3.1 角色隔离测试

**文件**: `frontend/tests/e2e/01-auth/role-isolation.spec.ts`

**测试目标**: 验证医生无法访问患者端任何页面，实现严格路由隔离

**核心测试场景**:
- 医生无法访问患者端首页、问诊列表、预约页面、聊天、个人中心
- 患者无法访问医生工作台、排班管理、预约管理、聊天页面
- 医生无法通过底部导航切换到患者端
- 所有未授权访问应重定向到对应角色的工作台

**预期修复方案**:
1. 增强 `ProtectedRoute` 组件
2. 为所有患者端路由添加角色检查
3. 添加全局路由守卫

---

### 3.2 排班验证测试

**文件**: `frontend/tests/e2e/03-appointment/schedule-validation.spec.ts`

**测试目标**: 验证医生设置的排班限制在患者端生效

**核心测试场景**:
- 医生设置不可用时段后，患者端应禁用该时段
- 排班已满后，时间段应显示"已满"或被禁用
- 后端 API 应验证排班限制并拒绝无效预约
- 批量排班后，患者端应正确显示所有状态

**预期修复方案**:
1. 后端 API 修改：查询医生排班，过滤不可用时段
2. 前端验证：显示但禁用不可用时段
3. 双重验证：前端禁用 + 后端拒绝

---

### 3.3 导航重定向逻辑测试

**文件**: `frontend/tests/e2e/04-navigation/redirect-logic.spec.ts`

**测试目标**: 验证所有返回按钮和导航操作都有正确的fallback处理

**核心测试场景**:
- 从详情页返回应正确回到列表页
- 从流程中途返回应保持数据
- 没有历史记录时的 fallback 处理
- 浏览器前进后退按钮
- 页面刷新后状态保持
- 未登录访问受保护页面应记住返回地址

**预期修复方案**:
1. 创建智能导航辅助函数 `useSmartNavigation`
2. 增强路由配置 - 添加404处理路由
3. 修改所有返回按钮 - 使用智能导航

---

### 3.4 问诊完整生命周期测试

**文件**: `frontend/tests/e2e/02-consultation/consultation-lifecycle.spec.ts`

**测试目标**: 验证专家问诊从创建到结束的完整状态流转

**核心测试场景**:
- 患者发起问诊 → 医生接单 → 聊天 → 结束问诊
- 医生拒绝接单后，患者端应显示提示
- 问诊超时自动处理
- 问诊列表按状态筛选准确性
- 医生接单后，患者端实时更新状态
- 患者发送消息后，医生端实时收到
- 多端同时在线时，消息同步到所有端

**预期修复方案**:
1. WebSocket 事件增强 - 确保状态变化实时推送
2. 状态管理优化 - 使用 MobX reactive 实时更新 UI
3. 多端同步机制 - 基于用户 ID 的消息广播

---

### 3.5 预约完整生命周期测试

**文件**: `frontend/tests/e2e/03-appointment/appointment-lifecycle.spec.ts`

**测试目标**: 验证预约挂号从创建到完成的完整状态流转

**核心测试场景**:
- 患者预约 → 医生确认 → 预约成功 → 就诊完成
- 医生拒绝预约后，患者端应显示提示
- 患者取消预约后，时间段应释放
- 预约时间过期后自动处理
- 预约列表按状态筛选准确性
- 同一患者不能同时预约多个医生（同一时段）
- 同一时段多患者预约同一医生（后端检测）

**预期修复方案**:
1. 预约状态管理 - 确保状态变更实时同步
2. 冲突检测 API - 后端检测并返回冲突信息
3. 前端验证 - 实时检查并禁用冲突时段
4. 时间段释放机制 - 取消预约后自动释放

---

### 3.6 WebSocket 通信测试

**文件**: `frontend/tests/e2e/02-consultation/websocket.spec.ts`

**测试目标**: 验证 WebSocket 连接的稳定性和消息可靠性

**核心测试场景**:
- WebSocket 连接建立和断开
- 网络断开后的自动重连
- 消息发送失败后的重试
- 离线消息缓存与同步
- 心跳保活机制
- 多设备同时在线的消息同步

**预期修复方案**:
1. 实现 WebSocket 重连机制
2. 添加消息发送队列和重试逻辑
3. 实现离线消息缓存

---

### 3.7 404 处理测试

**文件**: `frontend/tests/e2e/04-navigation/404-handling.spec.ts`

**测试目标**: 验证所有无效路由都有友好的处理

**核心测试场景**:
- 访问不存在的问诊 ID
- 访问不存在的预约 ID
- 访问不存在的页面路由
- 所有 404 应显示友好提示或重定向

**预期修复方案**:
1. 添加 404 路由处理
2. 所有 API 返回 404 时的统一处理
3. 友好的错误提示 UI

---

## P1 测试用例设计

### 4.1 Token 管理测试

**文件**: `frontend/tests/e2e/01-auth/token-management.spec.ts`

**核心测试场景**:
- Token 过期后自动刷新
- Token 刷新失败的处理
- 多标签页 Token 同步
- 退出登录后清除所有 Token

---

### 4.2 冲突检测测试

**文件**: `frontend/tests/e2e/03-appointment/conflict-detection.spec.ts`

**核心测试场景**:
- 同一患者同时预约多个医生
- 同一时段多患者预约同一医生
- 预约修改时检测与新预约的冲突
- 后端 API 的冲突检测准确性

---

### 4.3 并发操作测试

**文件**: `frontend/tests/e2e/05-data-consistency/concurrent-operations.spec.ts`

**核心测试场景**:
- 多患者同时预约同一时段
- 医生接单同时患者取消
- 同时发送多条消息的顺序保证
- 统计数据的实时准确性

---

### 4.4 医患协作场景测试

**文件**: `frontend/tests/e2e/02-consultation/collaboration.spec.ts`

**核心测试场景**:
- 医生接单后，患者端实时更新
- 患者发送消息，医生端收到通知
- 医生工作台统计数据实时更新
- 问诊状态变化的双端同步

---

### 4.5 浏览器导航行为测试

**文件**: `frontend/tests/e2e/04-navigation/browser-navigation.spec.ts`

**核心测试场景**:
- 浏览器前进后退按钮
- 页面刷新后的状态恢复
- 直接 URL 访问的处理
- 浏览器返回时的表单重复提交防护

---

## 风险与应对

### 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| WebSocket 连接不稳定 | 测试 flakes | 增加重试逻辑，增加等待时间 |
| 测试数据污染 | 测试失败 | 每个测试前清理数据，使用隔离的测试账号 |
| 异步操作时序 | 测试不可靠 | 使用合理的 waitFor 和 timeout |
| 多浏览器上下文资源消耗 | CI 超时 | 优化并行度，复用浏览器实例 |

### 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 测试暴露大量 Bug | 开发周期延长 | 优先修复 P0，P1-P3 可逐步修复 |
| 后端 API 不支持 | 测试无法通过 | 与后端团队协作，必要时 mock |
| 现有功能被破坏 | 回归问题 | 完善现有测试，添加回归保护 |

---

**文档版本**: v1.0
**最后更新**: 2026-01-26
